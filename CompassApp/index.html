<!DOCTYPE HTML>
<html>
  <head>
    <meta name="viewport" content="width=320; user-scalable=no" />
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>CompassApp</title>
      <link rel="stylesheet" href="master.css" type="text/css" media="screen" title="no title" charset="utf-8">
      <script>
      
      if ((navigator.userAgent.indexOf('iPhone') != -1) || (navigator.userAgent.indexOf('iPad') != -1)) {
          var s = document.createElement('script');
          s.src = "js/phonegap-1.0.0.iOS.js";
          s.type = 'text/javascript';
          document.getElementsByTagName('head')[0].appendChild(s);
      } else {
          console.log("insert phonegap script");
          var s = document.createElement('script');
          s.src = "js/phonegap-1.0.0.android.js";
          s.type = 'text/javascript';
          s.onload = init;
          document.getElementsByTagName('head')[0].appendChild(s);
      }


//var watchId;
var heading = 0;

function init() {
  console.log("init is called");
  if(typeof PhoneGap === "undefined") {
    setTimeout(init, 1);
    console.log("PhoneGap is not defined ");
    document.addEventListener("deviceready", 
      function() {
        console.log("phonegap is ready 00");
        isReady = true;
        var watchId = navigator.compass.watchHeading(compassSuccess, compassError, {frequency: 1000});
      }, 
      false
    );
  } else {
    console.log("PhoneGap is defined__ : " + PhoneGap.available);
    document.addEventListener("deviceready", 
      function() {
        console.log("phonegap is ready 11");
        isReady = true;
        var watchId = navigator.compass.watchHeading(compassSuccess, compassError, {frequency: 1000});
      }, 
      true
    );
    //setInterval(compassSuccess, 100);
  }
}

function compassSuccess(heading) {
  heading += 1;
  
  // draw angle string
  drawBackground();
  drawHeading(heading);
}

function compassError() {
}

function drawBackground() {
  var canvasNode = document.getElementById("can");
  ctx = canvasNode.getContext("2d");
  
  // clear rect
  ctx.clearRect(0, 0, 300, 300);
  ctx.save();
  
  ctx.fillStyle='rgb(255,255,0)';
  
  ctx.beginPath();
  ctx.translate(150, 150);
  ctx.font = "10pt Arial";
  ctx.rotate(-(Math.PI/180) * 100);
  var increaseNum = 10;
  for(var i=0; i<360; i+=increaseNum) {
    ctx.rotate( ((Math.PI/180) * increaseNum) );
    ctx.fillText("" + i, 90, 0);
  }
  ctx.restore();
  ctx.save();
}

function drawHeading(heading) {
  var canvasNode = document.getElementById("can");
  ctx = canvasNode.getContext("2d");
  
  // draw
  ctx.save();
  ctx.beginPath();
  ctx.strokeStyle='rgb(255,255,0)';
  ctx.lineWidth = 1;
  ctx.translate(150, 150);
  ctx.rotate( (Math.PI/180) * heading - (90 * Math.PI/180) );
  ctx.moveTo(-30, 0);
  ctx.lineTo(0, -10);
  ctx.lineTo(50, 0);
  ctx.lineTo(0, 10);
  ctx.lineTo(-30, 0);
  //ctx.arc(100,100,45,0,Math.PI/2,true);
  ctx.stroke();
  ctx.restore();
  //ctx.closePath();
  //ctx.save();
}

/*
function drawHand(radians, opts) {
      radians -= 90 * Math.PI/180; // fix orientation
      
      ctx.save();
      ctx.beginPath();
      ctx.translate(options.height/2, options.width/2);
      
      // Set hand styles
      ctx.strokeStyle = opts.color;
      ctx.lineWidth = opts.width;
      ctx.globalAlpha = opts.alpha;
      if (options.shadow === true) {
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        ctx.shadowBlur = 1;
        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
      }
                
      ctx.rotate(radians);
      ctx.moveTo(opts.start, 0);
      ctx.lineTo(opts.end, 0);
      ctx.stroke();
      ctx.restore();
    }
*/
 
////////////////////
        function startDotGame() {
                var canvas = document.getElementById("canvas1");
                ctx = canvas.getContext("2d");

                canvas.addEventListener("touchstart", function(event) {
                        ctx.beginPath();
                        ctx.lineWidth = 10;
                        ctx.moveTo(event.touches[0].pageX, event.touches[0].pageY);
                        ctx.lineTo(event.touches[0].pageX+1, event.touches[0].pageY+1);
                        ctx.stroke();
                });
                canvas.addEventListener("touchmove", function(event) {});
                canvas.addEventListener("touchend", function(event) {
                        ctx.stroke();
                        ctx.closePath();
                        ctx.save();
                        HybridFunc("addDot", function() {});
                });
                HybridFunc("startDot", function(value) {
                        ctx.beginPath();
                        ctx.fillText(value, 50, 50);
                        ctx.stroke();
                        ctx.closePath();
                        ctx.save();
                });
                document.getElementById('btn').value = "stop";
        }
///////////////// 

/*
// http://scurker.com/projects/jclock/jclock.js
(function($) {
        
  var jClock = window.jClock = function(clock, canvas, options) {
    
    var ctx, img;

    // Canvas isn't supported, abort
    if(!(ctx = canvas.getContext('2d'))) return;
    
    options = $.extend(true, {}, jClock.defaults, options);
    img = new Image();
    img.src = clock;
    
    // Need to wait until after the image is loaded
    img.onload = function() {
      tick();
      setInterval(tick, 1000);
    };
    
    // The ticker, draws the clock upon each tick
    function tick() {
      var now = new Date(),
          sec = now.getSeconds(),
          min = now.getMinutes(),
          hour = now.getHours();
      if(hour > 12) hour = hour % 12;
      
      // do the clock
      drawClock();
      
      // do the second hand
      if(options.secondHand === true) drawHand(sec * Math.PI/30, options.second);
      
      // do the minute hand
      drawHand((min + sec/60) * Math.PI/30, options.minute);
      
      // do the hour hand
      drawHand((hour + sec/3600 + min/60) * Math.PI/6, options.hour);
    }
    
    function drawClock() {
      ctx.clearRect(0, 0, options.height, options.width);
      ctx.drawImage(img, 0, 0, options.width, options.height);
      ctx.save();
    }
    
    function drawHand(radians, opts) {
      radians -= 90 * Math.PI/180; // fix orientation
      
      ctx.save();
      ctx.beginPath();
      ctx.translate(options.height/2, options.width/2);
      
      // Set hand styles
      ctx.strokeStyle = opts.color;
      ctx.lineWidth = opts.width;
      ctx.globalAlpha = opts.alpha;
      if (options.shadow === true) {
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
        ctx.shadowBlur = 1;
        ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
      }
                
      ctx.rotate(radians);
      ctx.moveTo(opts.start, 0);
      ctx.lineTo(opts.end, 0);
      ctx.stroke();
      ctx.restore();
    }

  };
  
  // Default options
  jClock.defaults = {   
    height: 125,
    width: 125,
    secondHand: true,
    shadow: true,
    second: {
      color: '#f00',
      width: 2,
      start: -10,
      end: 35,
      alpha: 1
    },
    minute: {
      color: '#fff',
      width: 3,
      start: -7,
      end: 30,
      alpha: 1
    },
    hour: {
      color: '#fff',
      width: 4,
      start: -7,
      end: 20,
      alpha: 1
    }     
  };
  
})(jQuery);
*/
	  </script>  

  </head>
  <!--<body onload="init();">-->
  <body>
    <h1>Compass</h1>
    <canvas id=can width=300 height=300 style="position:relative; border:1px solid #000;"></canvas>
  </body>
</html>
